<script>
  stlite.mount({
    requirements: ["requests", "Pillow"], // é€™è£¡ä¸å†éœ€è¦ google-generativeai
    entrypoint: "app.py",
    files: {
      "app.py": `
import streamlit as st
import requests
import json
import base64
from PIL import Image
import io

st.set_page_config(page_title="Gemini WASM Studio", layout="wide")

# --- å´é‚Šæ¬„ï¼šé‡‘é‘° ---
st.sidebar.title("ğŸ”‘ è¨­å®š")
user_api_key = st.sidebar.text_input("Enter Gemini API Key", type="password")

# --- æ ¸å¿ƒé‚è¼¯ï¼šä½¿ç”¨ REST API ---
def generate_via_rest(prompt, api_key):
    # Gemini 2.0 Flash REST ç«¯é»
    url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key={api_key}"
    
    headers = {'Content-Type': 'application/json'}
    
    # è¨­å®š Payload (è¦æ±‚åœ–ç‰‡è¼¸å‡º)
    payload = {
        "contents": [{
            "parts": [
                {"text": prompt}
            ]
        }],
        "generationConfig": {
            "response_modalities": ["IMAGE"]
        }
    }
    
    response = requests.post(url, headers=headers, json=payload)
    result = response.json()
    
    try:
        # æå–å›å‚³çš„ Base64 åœ–ç‰‡æ•¸æ“š
        img_data_base64 = result['candidates'][0]['content']['parts'][0]['inlineData']['data']
        return base64.b64decode(img_data_base64)
    except Exception as e:
        st.error(f"API å¤±æ•—: {result}")
        return None

# --- UI ä»‹é¢ ---
st.title("ğŸ­ Gemini 2.0 ç€è¦½å™¨ç‰ˆè¬å› ç”¢ç”Ÿå™¨")
user_text = st.text_input("è¼¸å…¥ä½ çš„è¬å› é»å­ï¼š")

if st.button("ğŸš€ ç”Ÿæˆ"):
    if not user_api_key:
        st.error("è«‹è¼¸å…¥ API Key")
    else:
        with st.spinner("æ€è€ƒä¸­..."):
            img_bytes = generate_via_rest(user_text, user_api_key)
            if img_bytes:
                st.image(img_bytes)
      `
    }
  }, document.getElementById("root"));
</script>
